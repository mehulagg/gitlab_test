<script>
import Icon from '~/vue_shared/components/icon.vue';
import SafeLink from 'ee/vue_shared/components/safe_link.vue';
import SeverityBadge from './severity_badge.vue';

export default {
  name: 'VulnerabilityDetails',
  components: {
    Icon,
    SafeLink,
    SeverityBadge,
  },
  props: {
    details: {
      type: Object,
      required: true,
    },
  },
  methods: {
    hasMoreValues(index, values) {
      return index < values.length - 1;
    },
    hasValue(field) {
      return field.value && field.value.length > 0;
    },
    hasInstances(field, key) {
      return key === 'instances' && this.hasValue(field);
    },
    hasIdentifiers(field, key) {
      return key === 'identifiers' && this.hasValue(field);
    },
    hasLinks(field, key) {
      return key === 'links' && this.hasValue(field);
    },
    hasSeverity(field, key) {
      return key === 'severity' && this.hasValue(field);
    },
  },
};
</script>

<template>
  <div class="border-white mb-0 px-3">
    <div v-for="(field, key, index) in details" :key="index" class="d-flex my-2">
      <label class="col-2 text-right font-weight-bold pl-0">{{ field.text }}:</label>
      <div class="col-10 pl-0 text-secondary">
        <div v-if="hasInstances(field, key)" class="info-well">
          <ul class="report-block-list">
            <li v-for="(instance, i) in field.value" :key="i" class="report-block-list-issue">
              <div class="report-block-list-icon append-right-5 failed">
                <icon :size="32" name="status_failed_borderless" />
              </div>
              <div class="report-block-list-issue-description prepend-top-5 append-bottom-5">
                <div class="report-block-list-issue-description-text">
                  {{ instance.method }}
                </div>
                <div class="report-block-list-issue-description-link">
                  <safe-link
                    :href="instance.uri"
                    target="_blank"
                    rel="noopener noreferrer nofollow"
                    class="break-link"
                  >
                    {{ instance.uri }}
                  </safe-link>
                </div>
                <expand-button v-if="instance.evidence">
                  <pre
                    slot="expanded"
                    class="block report-block-dast-code prepend-top-10 report-block-issue-code"
                  >
                  {{ instance.evidence }}</pre
                  >
                </expand-button>
              </div>
            </li>
          </ul>
        </div>
        <template v-else-if="hasIdentifiers(field, key)">
          <span v-for="(identifier, i) in field.value" :key="i">
            <safe-link
              v-if="identifier.url"
              :class="`js-link-${key}`"
              :href="identifier.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ identifier.name }}
            </safe-link>
            <span v-else> {{ identifier.name }} </span>
            <span v-if="hasMoreValues(i, field.value)">,&nbsp;</span>
          </span>
        </template>
        <template v-else-if="hasLinks(field, key)">
          <span v-for="(link, i) in field.value" :key="i">
            <safe-link
              :class="`js-link-${key}`"
              :href="link.url"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ link.value || link.url }}
            </safe-link>
            <span v-if="hasMoreValues(i, field.value)">,&nbsp;</span>
          </span>
        </template>
        <template v-else-if="hasSeverity(field, key)">
          <severity-badge :severity="field.value" class="d-inline" />
        </template>
        <template v-else>
          <safe-link
            v-if="field.isLink"
            :class="`js-link-${key}`"
            :href="field.url"
            target="_blank"
          >
            {{ field.value }}
          </safe-link>
          <span v-else :class="{ 'text-capitalize': key === 'confidence' }">
            {{ field.value }}
          </span>
        </template>
      </div>
    </div>
  </div>
</template>
