<script>
import { mapState, mapActions, mapGetters } from 'vuex';
import sum from 'lodash/sum';
import { GlButton, GlCard, GlIcon } from '@gitlab/ui';
import { __ } from '~/locale';
import { monitoringDashboard } from '~/monitoring/stores';
import MetricEmbed from './metric_embed.vue';

export default {
  components: {
    GlButton,
    GlCard,
    GlIcon,
    MetricEmbed,
  },
  props: {
    urls: {
      type: Array,
      required: true,
      validator: urls => urls.length > 0,
    },
  },
  data() {
    return {
      isCollapsed: false,
    };
  },
  computed: {
    ...mapState('embedGroup', ['module']),
    ...mapGetters('embedGroup', ['metricsWithData']),
    arrowIconName() {
      return this.isCollapsed ? 'chevron-right' : 'chevron-down';
    },
    bodyClass() {
      return ['border-top', 'pl-3', 'pt-3', { 'd-none': isCollapsed }];
    },
    buttonLabel() {
      return this.isCollapsed ? __('View charts') : __('Hide charts');
    },
    cardClass() {
      return { 'd-none': this.numCharts === 0 };
    },
    containerClass() {
      return isSingleChart ? 'col-lg-12' : 'col-lg-6';
    },
    numCharts() {
      if (this.metricsWithData === null) {
        return 0;
      }
      return sum(this.metricsWithData);
    },
    isSingleChart() {
      return this.numCharts === 1;
    },
  },
  created() {
    this.urls.forEach((url, index) => {
      const name = this.getNamespace(index);
      this.$store.registerModule(name, monitoringDashboard);
      this.addModule(name);
    });
  },
  methods: {
    ...mapActions('embedGroup', ['addModule']),
    getNamespace(id) {
      return `monitoringDashboard/${id}`;
    },
    toggleCollapsed() {
      this.isCollapsed = !this.isCollapsed;
    },
  },
};
</script>
<template>
  <gl-card
    class="collapsible-card border p-0 mb-3"
    :class="cardClass"
    header-class="d-flex align-items-center border-bottom-0 py-2"
    :body-class="bodyClass"
  >
    <template #header>
      <gl-button
        class="collapsible-card-btn d-flex text-decoration-none"
        :aria-label="buttonLabel"
        variant="link"
        @click="toggleCollapsed"
      >
        <gl-icon class="mr-1" :name="arrowIconName" />
        {{ buttonLabel }}
      </gl-button>
    </template>
    <div class="d-flex flex-wrap">
      <metric-embed
        v-for="(url, index) in urls"
        :key="index"
        :dashboard-url="url"
        :namespace="getNamespace(index)"
        :container-class="containerClass"
      />
    </div>
  </gl-card>
</template>
