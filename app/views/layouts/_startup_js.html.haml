- return unless page_startup_api_calls.present?
- ref = local_assigns.fetch(:ref) { current_ref }
- root_url = root_url()

= javascript_tag nonce: true do
  :plain
    var gl = window.gl || {};
    gl.startup_calls = #{page_startup_api_calls.to_json};
    gl.startup_graphql_calls = #{page_startup_graphql_calls.to_json};

    if (gl.startup_calls && window.fetch) {
      Object.keys(gl.startup_calls).forEach(apiCall => {
        // fetch wonâ€™t send cookies in older browsers, unless you set the credentials init option.
        // We set to `same-origin` which is default value in modern browsers.
        // See https://github.com/whatwg/fetch/pull/585 for more information.
        gl.startup_calls[apiCall] = {
          fetchCall: fetch(apiCall, { credentials: 'same-origin' })
        };
      });
    }
    if (window.fetch) {
      var url = `#{root_url}/api/graphql`
      var pathRegex = /-\/tree\/+.\/(.+$)/;
      var matches = window.location.href.match(pathRegex);
      var currentRoutePath = matches ? matches[1] : '';

      gl.startup_graphql_calls[0].variables = {
        projectPath: "#{@project.full_path}",
        path: `${currentRoutePath}`,
        ref: "#{ref}"
      }

      const opts = {
        method: "POST",
        headers: { "Content-Type": "application/json", 'X-CSRF-Token': "#{form_authenticity_token}" },
      };

      gl.startup_graphql_calls = gl.startup_graphql_calls.map(call => ({
        operationName: call.query.match(/^query (.+)\(/)[1],
        fetchCall: fetch(url, {
          ...opts,
          body: JSON.stringify(call)
        })
      }))
    }

